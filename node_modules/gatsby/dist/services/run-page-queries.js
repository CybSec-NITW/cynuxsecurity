"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.runPageQueries = runPageQueries;

var _query = require("../query");

var _reporter = _interopRequireDefault(require("gatsby-cli/lib/reporter"));

var _assertStore = require("../utils/assert-store");

var _showExperimentNotice = require("../utils/show-experiment-notice");

var _gatsbyCoreUtils = require("gatsby-core-utils");

const ONE_MINUTE = 1 * 60 * 1000;

async function runPageQueries({
  parentSpan,
  queryIds,
  store,
  program,
  graphqlRunner
}) {
  (0, _assertStore.assertStore)(store);

  if (!queryIds) {
    return;
  }

  const {
    pageQueryIds
  } = queryIds;
  const state = store.getState();
  const pageQueryIdsCount = pageQueryIds.filter(id => state.pages.has(id)).length;

  if (!pageQueryIdsCount) {
    return;
  }

  const activity = _reporter.default.createProgress(`run page queries`, pageQueryIdsCount, 0, {
    id: `page-query-running`,
    parentSpan
  });

  activity.start();
  let cancelNotice;

  if (process.env.gatsby_executing_command === `develop` && !process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND && !(0, _gatsbyCoreUtils.isCI)()) {
    cancelNotice = (0, _showExperimentNotice.showExperimentNoticeAfterTimeout)(`queryOnDemand`, _reporter.default.stripIndent(`
        Your local development experience is about to get better, faster, and stronger!

        Your friendly Gatsby maintainers detected your site takes longer than ideal to run page queries. We're working right now to improve this.

        If you're interested in trialing out one of these future improvements *today* which should make your local development experience faster, go ahead and run your site with QUERY_ON_DEMAND enabled.

        You can enable it by adding "flags: { QUERY_ON_DEMAND: true }" to your gatsby-config.js

        Please do let us know how it goes (good, bad, or otherwise) and learn more about it at https://gatsby.dev/query-on-demand-feedback
      `), ONE_MINUTE);
  }

  await (0, _query.processPageQueries)(pageQueryIds, {
    state,
    activity,
    graphqlRunner,
    graphqlTracing: program === null || program === void 0 ? void 0 : program.graphqlTracing
  });

  if (cancelNotice) {
    cancelNotice();
  }

  activity.done();
}
//# sourceMappingURL=run-page-queries.js.map